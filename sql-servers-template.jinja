resources:
- name: sql-template #template for sql vms
  type: compute.v1.instanceTemplate
  properties:
    properties:
      description: sql
      tags:
        items:
          - sqlserver
      zone: europe-west2-c #Deployment in london
      machineType: n1-standard-4 #Machine suited to business size and demand
      canIpForward: false
      disks:
      - deviceName: boot
        type: PERSISTENT #Persistent storage     
        boot: true
        autoDelete: true
        initializeParams:
          sourceImage: projects/bitnami-launchpad/global/images/bitnami-lampstack-7-1-26-0-linux-debian-9-x86-64 #Deploying Bitnami LAMP stack
      networkInterfaces:
      - network: $(ref.mobileapp-network.selfLink)
        subnetwork: $(ref.vm-subnet-private.selfLink) #Deploy in public subnet
        accessConfigs:
          - name: External NAT
            type: ONE_TO_ONE_NAT
      scheduling:
          onHostMaintenance: MIGRATE
          automaticRestart: true

- name: sql-ins-group #Group instances
  type: compute.v1.instanceGroup
  properties:
    namedPorts:
    - name: http #Declare port
      port: 80
    network: $(ref.mobileapp-network.selfLink) # Assign instances to network
    zone: europe-west2-c
    size: 3 #deploy 3
    subnetwork: $(ref.vm-subnet-private.selfLink) # Assign instances to public facing subnetwork       

   #group manager for sql instances
- name: sql-manager 
  type: compute.v1.instanceGroupManager
  properties:
    baseInstanceName: sql
    instanceGroup: $(ref.sql-ins-group.selfLink)
    instanceTemplate: $(ref.sql-template.selfLink) #refrence the template for a sql vm
    targetSize: 2
    zone: europe-west2-c
    
- name: sql-as #autoscaler for sql instances 
  type: compute.v1.autoscaler
  properties:
    zone: europe-west2-c
    target: $(ref.sql-manager.selfLink)
    autoscalingPolicy: #Autoscaling for scalability
      maxNumReplicas: 7